<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:composite="http://java.sun.com/jsf/composite"
      xmlns:smtk="http://java.sun.com/jsf/composite/smtk"
      xmlns:p="http://primefaces.org/ui">

<composite:interface >
    <composite:attribute name="relationshipDefinition" type="cl.minsal.semantikos.model.relationships.RelationshipDefinition" />
    <composite:attribute name="targetDefinition" type="cl.minsal.semantikos.model.helpertables.HelperTable" />
    <composite:attribute name="concept" type="cl.minsal.semantikos.model.ConceptSMTKWeb" />
</composite:interface>
<composite:implementation>
    <!-- Multiplicidad 1 y Nueva relacion -->
    <p:panel id="helperTableTypeSimpleNew"
             widgetVar="panelHelperTableTypeSimple#{cc.attrs.relationshipDefinition.id}"
             rendered="#{cc.attrs.relationshipDefinition.multiplicity.simple and not cc.attrs.concept.hasRelationships(cc.attrs.relationshipDefinition)}">

        <div class="ui-g">
            <div class="ui-g-12 ui-md-6 ui-lg-2">
                <p:outputLabel for="helperTableRecordsSimple" value="#{cc.attrs.relationshipDefinition.name}"/>
                <p:outputLabel value=" *" rendered="#{not cc.attrs.relationshipDefinition.multiplicity.optional}" />
            </div>
            <div class="ui-g-12 ui-md-6 ui-lg-10">



                <p:dataTable id="helperTableRecordsSimple"
                             var="helperTableRecord"
                             value="#{conceptBean.helperTableManager.getAllRecords(cc.attrs.targetDefinition)}"
                             selection="#{conceptBean.selectedHelperTableRecord}"
                             selectionMode="single"
                             reflow="true"
                             rowKey="#{helperTableRecord.fields.id}"
                             styleClass="relationships">
                    <p:ajax event="rowSelect" listener="#{conceptBean.addOrChangeRelationship(cc.attrs.relationshipDefinition,conceptBean.selectedHelperTableRecord)}" />
                    <p:columns value="#{cc.attrs.targetDefinition.showableColumns}"
                               var="column"
                               sortBy="#{helperTableRecord.fields[column.columnName]}"
                               rendered="#{column.columnName!='id'}">
                        <f:facet name="header">
                            <h:outputText value="#{column.columnName}" />
                        </f:facet>
                        <h:outputText value="#{helperTableRecord.fields.get(column.columnName)}" />
                    </p:columns>
                </p:dataTable>
            </div>
        </div>
    </p:panel>

    <!-- Multiplicidad 1 y relacion existente -->
    <p:panel id="helperTableTypeSimple"
             widgetVar="panelHelperTableTypeSimple#{cc.attrs.relationshipDefinition.id}"
             rendered="#{cc.attrs.relationshipDefinition.multiplicity.simple and cc.attrs.concept.hasRelationships(cc.attrs.relationshipDefinition)}">

        <ui:repeat value="#{cc.attrs.concept.getValidRelationshipsWebByRelationDefinition(cc.attrs.relationshipDefinition)}"
                   var="relationship"
                   varStatus="var">
            <div class="ui-g">
                <div class="ui-g-12 ui-md-6 ui-lg-2">
                    <p:outputLabel for="helperTableRecordsSimple2" value="#{cc.attrs.relationshipDefinition.name}"/>
                </div>
                <div class="ui-g-12 ui-md-6 ui-lg-10">
                    <p:dataTable id="helperTableRecordsSimple2"
                                 var="helperTableRecord"
                                 value="#{conceptBean.helperTableManager.getAllRecords(cc.attrs.targetDefinition)}"
                                 selection="#{relationship.target}"
                                 reflow="true"
                                 rowKey="#{helperTableRecord.fields.id}"
                                 styleClass="relationships"
                    >
                        <p:column selectionMode="single" style="width:16px;text-align:center"/>
                        <p:columns value="#{cc.attrs.targetDefinition.showableColumns}"
                                   var="column"
                                   sortBy="#{helperTableRecord.fields[column.columnName]}"
                                   rendered="#{column.columnName!='id'}">
                            <f:facet name="header">
                                <h:outputText value="#{column.columnName}" />
                            </f:facet>
                            <h:outputText value="#{helperTableRecord.fields.get(column.columnName)}" />
                        </p:columns>
                    </p:dataTable>
                </div>
            </div>
        </ui:repeat>
    </p:panel>


    <!-- Multiplicidad N sin atributos-->
    <p:panel id="helperTableTypeCollection"
             styleClass="helper#{cc.attrs.relationshipDefinition.id}"
             rendered="#{cc.attrs.relationshipDefinition.multiplicity.collection and empty cc.attrs.relationshipDefinition.relationshipAttributeDefinitions}">
        <smtk:relationshipValidator relationships="#{cc.attrs.concept.getValidRelationshipsWebByRelationDefinition(cc.attrs.relationshipDefinition)}"
                                    relationshipDefinition="#{cc.attrs.relationshipDefinition}"
        />
        <div class="ui-g">
            <div class="ui-g-12 ui-md-6 ui-lg-2">
                <p:outputLabel for="helperTableRecordsCollection" value="#{cc.attrs.relationshipDefinition.name}"/>
                <p:outputLabel value=" *" rendered="#{not cc.attrs.relationshipDefinition.multiplicity.optional}" />
            </div>
            <div class="ui-g-12 ui-md-6 ui-lg-10">
                <p:dataTable id="helperTableRecordsCollection"
                             var="helperTableRecord"
                             value="#{conceptBean.helperTableManager.getAllRecords(cc.attrs.targetDefinition)}"
                             reflow="true"
                             >
                    <p:columns value="#{cc.attrs.targetDefinition.showableColumns}"
                               var="column"
                               columnIndexVar="colIndex"
                               sortBy="#{helperTableRecord.fields[column.columnName]}"
                               rendered="#{column.columnName!='id'}">
                        <f:facet name="header">
                            <h:outputText value="#{column.columnName}" />
                        </f:facet>
                        <h:outputText value="#{helperTableRecord.fields.get(column.columnName)}" />
                    </p:columns>
                    <p:column style="width: 4%">
                        <p:commandButton
                                id="addHelperTableRelationship"
                                process="@this"
                                style="float: right"
                                disabled="#{cc.attrs.relationshipDefinition.multiplicity.isUpperBoundaryReached(cc.attrs.concept.getRelationshipsByRelationDefinition(cc.attrs.relationshipDefinition).size())}"
                                update="@(.helper#{cc.attrs.relationshipDefinition.id})"
                                action="#{conceptBean.addRelationship(cc.attrs.relationshipDefinition,helperTableRecord)}"
                                icon="fa fa-plus"
                                title="Agregar"
                        />
                    </p:column>
                </p:dataTable>
                <p:spacer />
                <p:dataTable id="collectionValues12"
                             styleClass="tablas"
                             var="relationship"
                             value="#{cc.attrs.concept.getValidRelationshipsWebByRelationDefinition(cc.attrs.relationshipDefinition)}"
                             style="width: 100%"
                             reflow="true">
                    <p:columns value="#{cc.attrs.targetDefinition.showableColumns}"
                               var="column"
                               columnIndexVar="colIndex"
                               sortBy="#{relationship.target.fields[column.columnName]}"
                               rendered="#{column.columnName!='id'}">
                        <f:facet name="header">
                            <h:outputText value="#{column.columnName}" />
                        </f:facet>
                        <h:outputText value="#{relationship.target.fields.get(column.columnName)}" />
                    </p:columns>
                    <p:column style="width: 4%">
                        <p:commandButton
                                icon="fa fa-trash"
                                title="Eliminar"
                                update="@(.helper#{cc.attrs.relationshipDefinition.id})"
                                style="float: right"
                                process="@this"
                                immediate="true"
                                actionListener="#{conceptBean.removeRelationship(cc.attrs.relationshipDefinition, relationship)}"
                                styleClass="relationships"
                        />
                    </p:column>
                </p:dataTable>
            </div>
        </div>
    </p:panel>

    <!-- Multiplicidad N con atributos-->
    <p:panel id="helperTableTypeCollectionWithAttributes"
             styleClass="helper#{cc.attrs.relationshipDefinition.id}"
             rendered="#{cc.attrs.relationshipDefinition.multiplicity.collection and not empty cc.attrs.relationshipDefinition.relationshipAttributeDefinitions}">
        <smtk:relationshipValidator relationships="#{cc.attrs.concept.getValidRelationshipsWebByRelationDefinition(cc.attrs.relationshipDefinition)}"
                                    relationshipDefinition="#{cc.attrs.relationshipDefinition}"
        />

        <h3>#{cc.attrs.relationshipDefinition.name}</h3>

        <p:spacer />

        <div class="ui-g">

            <p:panel id="attrs" styleClass="attributes_#{cc.attrs.relationshipDefinition.name}" style="width:100%">

                <p:growl id="growl" showDetail="true" showSummary="true"/>

                <div class="ui-g-12 ui-md-6 ui-lg-2">

                    <p:autoComplete id="findHTRecords3" scrollHeight="200" style="width: 90%;"
                                    inputStyle="width: 90%;"
                                    completeMethod="#{helperTableBean.getRecordSearchInput}"
                                    var="record"
                                    placeholder="Buscar..."
                                    converter="helperTableRecordConverter"
                                    validator="#{validatorBean.validateRequiredRecordSelect}"
                                    value="#{conceptBean.selectedHelperTableRecord}"
                                    itemLabel="#{record.fields['description']}"
                                    itemValue="#{record}"
                    >
                        <!-- Parámetros del buscador -->
                        <f:attribute name="helperTable" value="#{cc.attrs.relationshipDefinition.targetDefinition}"  />
                        <!-- Parámetros del validador -->
                        <f:attribute name="helperTableRecord" value="#{conceptBean.selectedHelperTableRecord}"  />
                        <!---->

                        <p:column>
                            <h:outputText value="#{record.fields['description']}"/>
                        </p:column>

                        <p:ajax event="itemSelect"
                                listener="#{conceptBean.setTarget(cc.attrs.relationshipDefinition, conceptBean.selectedHelperTableRecord)}"
                                process="@this"/>

                    </p:autoComplete>

                </div>

                <!-- Atributos de relación -->
                <p:repeat
                        offset="0"
                        size="#{cc.attrs.relationshipDefinition.relationshipAttributeDefinitions.size()}"
                        step="1"
                        varStatus="var"
                        value="#{cc.attrs.relationshipDefinition.relationshipAttributeDefinitions}"
                        var="relationshipAttributeDefinition">
                    <smtk:basicTypeAttribute relationshipDefinition="#{cc.attrs.relationshipDefinition}"
                                             relationshipAttributeDefinition="#{relationshipAttributeDefinition}"
                                             targetDefinition="#{relationshipAttributeDefinition.targetDefinition}"
                                             rendered="#{relationshipAttributeDefinition.targetDefinition.basicType}"
                    />
                    <smtk:helperTableTypeAttribute relationshipDefinition="#{cc.attrs.relationshipDefinition}"
                                                   relationshipAttributeDefinition="#{relationshipAttributeDefinition}"
                                                   targetDefinition="#{relationshipAttributeDefinition.targetDefinition}"
                                                   rendered="#{relationshipAttributeDefinition.targetDefinition.helperTable}"
                    />
                </p:repeat>

                <div class="ui-g-12 ui-md-6 ui-lg-1">
                    <p:commandButton
                            process="@(.attributes_#{cc.attrs.relationshipDefinition.name})"
                            action="#{conceptBean.addRelationshipWithAttributes(cc.attrs.relationshipDefinition)}"
                            update="@(.relationshipsWithAttributes_#{cc.attrs.relationshipDefinition.name}),@(.attributes_#{cc.attrs.relationshipDefinition.name})"
                            value="Agregar">
                    </p:commandButton>
                </div>

                <div class="ui-g-12 ui-md-6 ui-lg-3">
                    <smtk:info relationshipDefinition="#{cc.attrs.relationshipDefinition}" />
                </div>
            </p:panel>
        </div>

        <div class="ui-g">
            <p:spacer />
            <p:dataTable id="collectionValuesWithAttributes"
                         styleClass="relationshipsWithAttributes_#{cc.attrs.relationshipDefinition.name}"
                         var="relationship"
                         value="#{cc.attrs.concept.getValidRelationshipsWebByRelationDefinition(cc.attrs.relationshipDefinition)}"
                         style="width: 100%"
                         reflow="true">
                <p:columns value="#{cc.attrs.targetDefinition.showableColumns}"
                           var="column"
                           columnIndexVar="colIndex"
                           sortBy="#{relationship.target.fields[column.columnName]}"
                           rendered="#{column.columnName!='id'}">
                    <f:facet name="header">
                        <h:outputText value="#{column.columnName}" />
                    </f:facet>
                    <h:outputText value="#{relationship.target.fields.get(column.columnName)}" />
                </p:columns>

                <p:columns value="#{cc.attrs.relationshipDefinition.relationshipAttributeDefinitions}"
                           var="attribute"
                           columnIndexVar="colIndex"
                >
                    <f:facet name="header">
                        <h:outputText value="#{attribute.name}" />
                    </f:facet>
                    <h:outputText value="#{rel.relationshipAttributes.get(colIndex).target}" />
                </p:columns>

                <p:column style="width: 4%">
                    <p:commandButton
                            icon="fa fa-trash"
                            title="Eliminar"
                            update="@(.helper#{cc.attrs.relationshipDefinition.id})"
                            style="float: right"
                            process="@this"
                            immediate="true"
                            actionListener="#{conceptBean.removeRelationship(cc.attrs.relationshipDefinition, relationship)}"
                            styleClass="relationships"
                    />
                </p:column>
            </p:dataTable>
        </div>
    </p:panel>

</composite:implementation>
</html>
